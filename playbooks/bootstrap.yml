---
- name: Bootstrap server for future ansible runs
  hosts: all
  remote_user: osaa

  vars: 
    user_name: ansible
    user_pass: $6$6pQ2yrRDTSN8a$GcILzCBJoqU88xRdYQL3u35UBHtecdcDxF.odzSJMZCHK.Rw/dUD08eIfu4SBdvmpezzvVSrPz/M6OkiJH1.q.
    ansible_ssh_private_key_file: ./certificates/bootstrap_ed25519

  tasks: 
  - name: Update apt cache
    apt: update_cache=yes
    become: true

  - name: Safe aptitude upgrade
    apt: upgrade=safe
    async: 600
    poll: 5
    become: true

  - name: Add my user
    user: >
      name={{ user_name }} 
      password={{ user_pass }} 
      shell=/bin/bash 
      groups=sudo 
      append=yes 
      generate_ssh_key=yes 
      ssh_key_bits=2048 
      state=present
    become: true

  - name: Add my workstation user's public key to the new user
    authorized_key: 
      user: "{{ user_name }}"
      key: "{{ lookup('file', 'certificates/bootstrap_ed25519.pub') }}" 
      state: present
    become: true

  - name: Remove root SSH access
    lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: "^PermitRootLogin" 
      line: "PermitRootLogin no" 
      state: present
    become: true

  - name: Remove password SSH access
    lineinfile: 
      dest: /etc/ssh/sshd_config 
      regexp: "^PasswordAuthentication" 
      line: "PasswordAuthentication no" 
      state: present
    become: true
